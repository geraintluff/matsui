<!DOCTYPE html>
<html>
	<head>
		<title>Matsui</title>
		<meta charset="utf8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- includes main.js/main.css-->
		<link href="/style/blog/dist.css" rel="stylesheet">
		<script src="/style/blog/dist.js" defer class="style-main"></script>
		
		<script src="../matsui.js"></script>
		
		<style>
			.example, article.full .example {
				text-align: start;
				border: 1px solid #BBB;
				border-radius: 4px;
				background: #FFF;
				padding: 0;
				box-shadow: none;
				max-width: 300pt;
				margin: 0 auto 1.5rem auto;
				position: relative;
				z-index: 1;
				box-sizing: border-box;
			}
			@media (min-width: 600pt) {
				.example {
					float: right;
					clear: right;
					margin-left: 0.8em;
					margin-bottom: 1em;
				}
			}
			.example figure {
				text-align: start;
				padding: 0.5em 0.5em;
				margin: 0;
				width: 100%;
				max-width: 100%;
			}
			.example pre code {
				font-size: 0.8em;
			}
			.example-result, .example-js {
				background-color: #DDD5;
				padding: 0.5rem;
				border-top: 1px solid #BBB;
			}
			.example-js {
				background-color: #DEF8;
			}
			.example-result {
				border-bottom-left-radius: 4px;
				border-bottom-right-radius: 4px;
			}
			.example figure::before {
				content: "label";
				float: right;
				font-size: 0.65em;
				margin: 0;
				margin-top: -0.3rem;
				line-height: 1;
				padding: 0;
			}
			.example figure.example-html::before {
				content: "HTML";
				color: #600;
			}
			.example figure.example-js::before {
				content: "JS";
				color: #008;
			}
			.example figure.example-result::before {
				content: "result";
				color: #060;
			}
		</style>

		<template id="matsui-template">
			<figure class="example-html small"><pre class="language-html"><code>${data => (data.html || '').trim()}</code></pre></figure>
			<figure class="example-js small"><pre class="language-javascript"><code>${data => (data.js || '').trim().split('\n').map(x => "\t" + x).join("\n")}
			</code></pre><figcaption>{caption}</figcaption></figure>
			<figure class="example-result"></figure>
		</template>
		<script>
			let exampleTemplate = Matsui.template.fromElement(document.querySelector('#matsui-template'));
			function matsuiExample(obj) {
				let container = document.createElement('div');
				container.className = "example";
				document.currentScript.replaceWith(container);
				Matsui.show(container, obj, exampleTemplate);
				
				// Show result HTML
				let resultContainer = container.querySelector('.example-result');
				resultContainer.innerHTML = obj.html;
				// Execute JS
				let vars = Object.keys(obj.vars || {});
				let fn = Function.apply(null, vars.concat(obj.js + '\n' + (obj.extraJs || '')));
				let values = vars.map(name => {
					let value = obj.vars[name];
					if (typeof value === 'string') return resultContainer.querySelector(value);
					return value(resultContainer);
				});
				
				fn.apply(null, values)
			};
		</script>
	</head>
	<body>
		<script>
			if (0) {
				let nodeObserver = new MutationObserver(records => {
					records.forEach(record => {
						if (record.type == "characterData") {
							console.log("text:", record.target.nodeValue);
						} else if (record.type == "attribute") {
							console.log("attr:", record.attributeName, record.target.getAttribute(record.attributeName));
						} else {
							console.log("add", record.addedNodes, "remove", record.removedNodes);
						}
					});
				});
				nodeObserver.observe(document.body, {subtree: true, childList: true, characterData: true});
			}
		</script>
		<header class="blog"></header>
		<article class="main full">
			<header>
				<h1>Matsui</h1>
				<img src="Ricky_Matsui.png" style="float:right;height:4rem;width:4rem;margin:-4.5rem 0.25em 0 0;border-radius:5px">
				<p>Simple data-driven UIs</p>
			</header>
			
			<p>I wanted a framework/library for interactive UIs, but I'm uncomfortable with magic I don't understand, so I made something simple enough for me to explain how it's implemented.</p>

			<script>
				matsuiExample({
					html: `<script src="matsui.js"></${'script'}>

<div>
	<div>Counter: {counter}</div>
	<div>Doubled: \${data => data.counter*2}</div>
	<button $click="\${data => data.counter++}">
		add
	</button>
</div>`,
					js: `Matsui.replace(div, {counter: 0});`,
					vars: {
						div: 'div'
					}
				});
			</script>

			<h2>Overview</h2>

			<h3>Principles</h3>
			<ul>
				<li>concise implementation
				<li>only updates the page where needed
				<li>plain JavaScript library (no compilation step)
				<li>CSP (Content Security Policy) support
			</ul>
			
			<h3>Data & Templates</h3>
			<p>The data is JSON-like, except <code>null</code> is equivalent to a value/property not existing.  You interact with it by directly changing values (rather than calling methods).</p>
			<p>Templates are functions which produce a node and a list of update functions, each making DOM changes based on their single <code>data</code> argument.  You can write templates in a <code>{...}</code>-based syntax, or directly in JavaScript.</p>
			
			<h3>Partial Updates</h3>
			<p>Matsui uses various <code>Proxy</code>s to:</p>
			<ul>
				<li>generate a merge object for all changes made to the data</li>
				<li>associate a "hidden merge" with data objects (which recurses appropriately through property access)</li>
				<li>track how a data object is accessed</li>
			</ul>
			<p>When update functions are called, it keeps track of what parts of the data they use.  When the data is changed, a merge object is attached to the data, and it only calls update functions affected by the merge.</p>
			
			<h2>HTML Template Syntax</h2>
			<p>Templates use <code>{...}</code> (property name) and <code>${...}</code> (expressions) inside strings.  The JavaScript expressions in <code>${...}</code> must evaluate to a function, taking data as their first argument.</p>

			<script>
				matsuiExample({
					html: `
<template id="greet">
	<p>Hello {name}! 1+1=\${data => 1 + 1}</p>
</template>

<div></div>`,
					js: `
let template = Matsui.template.fromElement(greet);
let data = {name: "you"};
let render = Matsui.show(div, data, template);
`,
					vars: {
						div: 'div',
						greet: '#greet'
					}
				});
			</script>
			<h3>Named templates</h3>
			<p>These values can be prefixed with a template identifier (e.g. <code>$list</code>) which specifies which template should be used to render that value:</p>
			<script>
				matsuiExample({
					html: `
<template id="item">
	<li>{=}</li>
</template>

<template id="nums">
	<ol>
		$list$item{list}
	</ol>
</template>

<div></div>`,
					js: `
let template = Matsui.template.fromElement(nums);
let data = {
	list: ["one", "two", "three"]
};
let render = Matsui.show(div, data, template);
`,
					extraJs: `
data = render.data();
setInterval(() => {
	let index = Math.floor(Math.random()*data.list.length);
	data.list[index] = data.list[index].replace(/[a-z]/ig, letter => {
		if (Math.random() < 0.5) return letter.toUpperCase();
		return letter.toLowerCase();
	});
}, 500);
`,
					vars: {
						div: 'div',
						myList: '#myList'
					}
				});
			</script>

			<h3>In-place templates</h3>
			<p>When you make a template from an existing element, it returns the original node(s) the first time you use that template (and copies from then on).</code>
			<p>This probably doesn't make a difference for <code>&lt;template></code>s, but it means if you fill an element out <em>using itself as a template</em>, you end up modifying the existing page's DOM nodes in-place.
			
			<h3>CSP support</h3>
			<p><a href="https://content-security-policy.com/">Content Security Policies</a> place extra restrictions on what gets run/displayed in a web-page.  This often includes banning <code>eval</code>/<code>Function()</code>, inline event handlers (<code>onclick="myFunc()"</code>) and inline <code>&lt;script></code> elements.</p>
			<p>When this is active, we can't define templates using DOM nodes, but we can use the same syntax as a tagged template:</p>
			<script>
				matsuiExample({
					html: `
<div></div>`,
					js: `
let template = Matsui.html\`
	<p>Hello {name}! 1+1=\${data => 1 + 1}</p>
\`;
let data = {name: "you"};
let render = Matsui.show(div, data, template);
`,
					vars: {
						div: 'div'
					}
				});
			</script>
			<p>

			<hr>
			


			<p>There are some basic templates included, and helper functions for making templates from HTML, <code>&lt;template></code>s or existing nodes - but you can also create your own:</p>

			<script>
				matsuiExample({
					html: `<div></div>`,
					js: `
let textTemplate = function() {
	let node = document.createTextNode("");
	let updateFn = data => {
		node.nodeValue = data;
	};
	return {
		node: node,
		updates: [updateFn]
	};
}

Matsui.show(div, "Hello!", textTemplate);`,
					vars: {
						div: 'div'
					},
					caption: `This is exactly how <code>Matsui.template.text</code> works`
				});
			</script>

		</article>
	</body>
</html>

<!DOCTYPE html>
<html>
	<head>
		<title>Uglify</title>
		<meta charset="utf8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<style>
			body {
				margin: 0;
				padding: 0;
				display: flex;
				height: 100vh;
				width: 100vw;
				flex-direction: row;
				font-family: "Segoe UI", Frutiger, "Frutiger Linotype", "Dejavu Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
				font-size: 12pt;
				font-size: calc(max(8pt, min(12pt, 3vw)));
				tab-size: 4;
			}
			body {
				flex-wrap: wrap;
			}
			#input-column, #results {
				flex-grow: 1;
				flex-basis: 300pt;
			}
			#input-column {
				display: flex;
				justify-content: stretch;
			}
			#input {
				flex-grow: 1;
			}
			#results {
				display: flex;
				flex-direction: column;
			}
			#controls {
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
				flex-grow: 0;
			}
			#controls > * {
				flex-grow: 1;
				width: 5em;
				line-height: 2;
				text-align: center;
			}
			button {
				background: #333;
				color: #FFF;
				border: 2px solid #000;
				font: inherit;
				padding: 0;
				flex-grow: 1;
				cursor: pointer;
			}
			#options-button {
				background: #FFF;
				color: #000;
				border-color: #DDD;
			}
			#result-size {
				padding: 0em 0.5em;
				white-space: nowrap;
			}
			#output {
				flex-grow: 1;
				background: #EEE;
			}
			textarea {
				font-size: 0.85em;
				font-family: "Lucida Console", "Lucida Sans Typewriter", monaco, "Bitstream Vera Sans Mono", monospace;
				padding: 0.5em;
				resize: none;
				border: none;
				border-radius: 0;
			}
			
			#file-column {
				display: flex;
				flex-direction: column;
				justify-content: space-between;
				background: #DDD;
				border-right: 1px solid #888;
			}
			#file-list {
				display: flex;
				flex-direction: column;
			}
			#file-column button {
				position: relative;
				background: #EEE;
				color: #000;
				border: 1px solid #8888;
				border-right: none;
				line-height: 2;
				flex-grow: 0;
			}
			
			.tab-left {
				position: relative;
				margin: 0.3em 0 0.3em 0.3em;
				padding: 0 0.3em;
				border-radius: 0.5em 0 0 0.5em;
				box-shadow: -2px 0px 1px #0001 inset;
				left: 0;
				transition: left 0.05s, padding 0.05s;
			}
			#file-column .tab-left.selected {
				box-shadow: none;
				background: #FFF;
				border-color: #000;
			}
			
			.interaction-drop {
				outline: 0.5em dotted currentcolor;
				outline-offset: -0.65em;
				opacity: 0.65;
			}
			
			dialog::backdrop {
				background-color: #8889;
				backdrop-filter: blur(1px) grayscale(50%);
				cursor: pointer; /* click to exit */
			}
			
			dialog {
				border-radius: 5px;
			}

		</style>
	</head>
	<body>

		<script>
			function dropFiles(data, files) {
				Promise.all(files.map(f =>
					f.text().then(text => ({
						name: f.name,
						code: text
					}))
				)).then(list => {
					if (!Array.isArray(data.input)) data.input = [];
					data.input = data.input.concat(list);
				});
			}
		</script>
		<div id="input-column" $drop-file="${dropFiles}">
			<template @if="${d => Array.isArray(d.input)}">
				<div id="file-column">
					<div id="file-list">
						<template @foreach="{input}">
							<button class="tab-left"
								$click="${(d, e, node) => {
									document.querySelector('#input').value = d.code;
									node.parentNode.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
									node.classList.add('selected');
								}}"
								>${d => d.name}</button>
						</template>
					</div>
					<button id="combine-files-button" $click="${d => d.input = d.input
						.map(file => `//---- ${file.name} ----\n\n${file.code}`)
						.join('\n\n')
					}">clear</button>
				</div>
				<textarea id="input" readonly></textarea>
			</template>
			<template @if="${d => !Array.isArray(d.input)}">
				<textarea id="input" placeholder="JS code" autofocus
					$input-keypath="input"
					$input-done="${run}"></textarea>
			</template>
		</div>
		
		<div id="results">
			<div id="controls">
				<button id="go-button" $click="${run}">minify</button>
				<button id="options-button" $click="${d => d.optionsDialog = true}">options</button>
				<div id="result-size">${d =>
					(Array.isArray(d.input) ? d.input.map(f => f.code).join('') : d.input).length} â†’ ${d => (d.output.error ? 'Error' : d.output.code.length + ' bytes')}</div>
				<label>
					<input type="checkbox" $input-keypath="live">
					live
				</label>
			</div>
			<textarea id="output" placeholder="minified" readonly
				$value="${d => d.output.error || d.output.code}"></textarea>
		</div>
		
		<template @if="{optionsDialog}">
			<dialog $modal="1" $modal-close="${d => d.optionsDialog = false}">
				<div>Hello!
				</div>
			</dialog>
		</template>

		<!-- npx uglify-js --self --compress --mangle --output uglify.min.js -->
		<script src="uglify.min.js"></script>
		<script src="../matsui.js"></script>
		<script src="../extra/sync.js"></script>
		<script src="../extra/log-dom.js"></script>
		<script src="../extra/interaction.js"></script>
		<script>
			function run(data) {
				let $ = document.querySelector.bind(document);

				let options = JSON.parse(JSON.stringify(data.options));
				if (options.mangle && options.mangle.properties && options.mangle.properties.regex) {
					options.mangle.properties.regex = new RegExp(options.mangle.properties.regex);
				}
				let inputCode = Array.isArray(data.input) ? data.input.map(f => f.code).join('\n;') : data.input;
				let outputObj = UglifyJS.minify(inputCode, options);
				data.output = outputObj;
			}
		
			function defaultOptions() {
				return {
					compress: {
						passes: 2
					},
					mangle: {
						properties: {
							regex: "^(m_|#)"
						}
					},
					output: {
						ascii_only: true
					}
				};
			}
			let wrapped = Matsui.replace(document.body, {
				input: 'console.log("Hello, world!");',
				live: false,
				output: {code: ''},
				options: defaultOptions()
			});
			
			// Live updates, if enabled
			let notBefore = 0;
			let liveTimeout = null;
			wrapped.addUpdates(data => {
				let go = () => {
					let start = Date.now();
					run(data);
					let duration = Date.now() - start;
					notBefore = Date.now() + duration; // only half the time
				};
				if (data.live) {
					if (Date.now() > notBefore) {
						clearTimeout(liveTimeout);
						go();
					} else {
						clearTimeout(liveTimeout);
						setTimeout(go, notBefore - Date.now() + 10);
					}
				}
			});
			
			wrapped.syncHash(data => ({
				get path() {
					return data.live ? 'live' : '';
				},
				set path(path) {
					data.live = (path == 'live');
				},
				get query() {
					return Matsui.merge.make(defaultOptions(), data.options)
				},
				set query(query) {
					data.options = Matsui.merge.apply(defaultOptions(), query);
				}
			}));
			wrapped.syncLocalStorage(data => ({
				get uglifyInput() {
					return data.input;
				},
				set uglifyInput(input) {
					if (input) data.input = input;
				},
			}));
		</script>
	</body>
</html>
